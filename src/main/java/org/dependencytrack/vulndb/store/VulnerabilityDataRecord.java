package org.dependencytrack.vulndb.store;

import org.dependencytrack.vulndb.api.Source;
import org.dependencytrack.vulndb.api.Vulnerability;
import org.jdbi.v3.json.Json;

import jakarta.annotation.Nullable;
import java.time.Instant;
import java.util.List;

public record VulnerabilityDataRecord(
        String sourceName,
        String vulnId,
        @Nullable String description,
        @Nullable @Json List<Integer> cwes,
        @Nullable Instant sourceCreatedAt,
        @Nullable Instant sourcePublishedAt,
        @Nullable Instant sourceUpdatedAt,
        @Nullable Instant sourceRejectedAt,
        Instant createdAt,
        @Nullable Instant updatedAt) {

    static VulnerabilityDataRecord of(final Source source, final Vulnerability vuln) {
        return new VulnerabilityDataRecord(
                source.name(),
                vuln.id(),
                vuln.description(),
                vuln.cwes() != null
                        ? vuln.cwes().stream().sorted().toList()
                        : null,
                vuln.createdAt() != null
                        ? Instant.ofEpochSecond(vuln.createdAt().getEpochSecond())
                        : null,
                vuln.publishedAt() != null
                        ? Instant.ofEpochSecond(vuln.publishedAt().getEpochSecond())
                        : null,
                vuln.updatedAt() != null
                        ? Instant.ofEpochSecond(vuln.updatedAt().getEpochSecond())
                        : null,
                vuln.rejectedAt() != null
                        ? Instant.ofEpochSecond(vuln.rejectedAt().getEpochSecond())
                        : null,
                null,
                null);
    }

}
